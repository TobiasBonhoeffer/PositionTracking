<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #map-canvas-id {
            height: 100%;
            width: 100%;
        }
    </style>

    <script>
        window.detectLocation = function () {
            return {
                protocol: window.location.protocol,
                host: window.location.host
            };
        };

        window.useMap = function (id, home, map_center, home_icon, tracker_icon) {
            const map = { id, home, map_center, home_icon, tracker_icon };

            if (typeof google === 'undefined') {
                window.google = null;
                window.mapZoom = {%zoom%};
                window.map = [];
                window.homeMarker = [];
                window.trackerMarker = [];
                window.trackerMarkerState = [];
                window.trackerBase64 = tracker_icon;
                window.deferredMaps = [map];

                const script = document.createElement("script");
                script.src = "//maps.googleapis.com/maps/api/js?key={%apikey%}&callback=initMaps";
                document.head.appendChild(script);
            } else if (google === null) {
                window.deferredMaps.push(map);
            } else {
                window.initMap(id, home, map_center, home_icon, tracker_icon);
            }
        };

        window.initMaps = function () {
            for (const map of window.deferredMaps) {
                window.initMap(map.id, map.home, map.map_center, map.home_icon, map.tracker_icon);
            }
        };

        window.moveMapMarker = function (id, lat, lng, heading) {
            const position = new google.maps.LatLng(lat, lng);
            const icon = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
                        <g transform="rotate(${heading}, 50, 50)">
                            <image href="data:image/png;base64,${window.trackerBase64}" height="100" width="100"/>
                        </g>
                    </svg>
                `),
                scaledSize: new google.maps.Size(36, 36)
            };

            if (!window.trackerMarker[id]) {
                window.trackerMarker[id] = new google.maps.Marker({
                    position: position,
                    map: window.map[id],
                    icon: icon
                });
            } else {
                window.trackerMarker[id].setPosition(position);
                window.trackerMarker[id].setIcon(icon);
            }
        };

        window.initMap = function (id, home, map_center, home_icon, tracker_icon) {
            const location = window.detectLocation();
            window.trackerBase64 = tracker_icon;

            const homePos = JSON.parse(home);
            const centerPos = JSON.parse(map_center);
            const mapOptions = {
                zoom: window.mapZoom,
                center: new google.maps.LatLng(centerPos.latitude, centerPos.longitude),
                mapTypeId: '{%maptype%}',
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: false
            };

            window.map[id] = new google.maps.Map(
                document.getElementById('map-canvas-' + id), mapOptions
            );

            window.homeMarker[id] = new google.maps.Marker({
                position: new google.maps.LatLng(homePos.latitude, homePos.longitude),
                map: window.map[id],
                icon: {
                    url: 'data:image/png;base64,' + home_icon,
                    scaledSize: new google.maps.Size(36, 36)
                }
            });

            // Fetch initial position
            fetch(location.protocol + "//" + location.host + "/hook/position_tracking/" + id)
                .then(response => response.json())
                .then(data => {
                    console.log("Initial tracker data:", data);
                    window.moveMapMarker(id, data.latitude, data.longitude, data.heading || 0);
                })
                .catch(error => console.error("Error fetching initial tracker data:", error));

            // WebSocket updates
            const ws = new WebSocket(
                location.protocol.replace("http", "ws") +
                "//" + location.host + "/hook/position_tracking/" + id
            );

            ws.addEventListener('message', function (event) {
                const data = JSON.parse(event.data);
                window.moveMapMarker(id, data.latitude, data.longitude, data.heading || 0);
            });
        };

        // Load the map with required data
        useMap(
            parseInt('{%id%}'),
            '{%home%}',
            '{%map_center%}',
            '{%home_icon%}',
            '{%tracker_icon%}'
        );
    </script>
</head>
<body>
    <div id="map-canvas-id"></div>
</body>
</html>
