<html>
<head>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

       html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}

#map-canvas-id {
    height: 100vh;
    width: 100vw;
}

        .map-button-id {
            appearance: button;
            background-color: #fff;
            border: 0;
            border-radius: 2px;
            box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            margin: 10px;
            padding: 0 0.5em;
            height: 40px;
            font: 400 16px Roboto, Arial, sans-serif;
            overflow: hidden;
        }

        .map-button-id:hover {
            background: #ebebeb;
        }
    </style>

    <script>
        window.detectLocation = function () {
            if (window.location.href.substr(0, 5) === "data:") {
                let data = decodeURIComponent(window.location.href);
                let match = data.match(/<base href="(http:|https:)\/\/(.*?)[\/]*"[\/]*>/);
                if (match) return { protocol: match[1], host: match[2] };
                document.write("Cannot detect protocol/host on IPSStudio Client!");
                throw 'Cannot detect protocol/host on IPSStudio Client!';
            } else if (window.location.href === 'about:blank') {
                let match = document.head.innerHTML.match(/<base href="(http:|https:)\/\/(.*?)[\/]*"[\/]*>/);
                return match ? { protocol: match[1], host: match[2] } : {
                    protocol: window.top.location.protocol,
                    host: window.top.location.host
                };
            } else if (window.location.href === 'about:srcdoc') {
                let match = document.body.innerHTML.match(/<base href="(http:|https:)\/\/(.*?)[\/]*"[\/]*>/);
                return match ? { protocol: match[1], host: match[2] } : {
                    protocol: window.top.location.protocol,
                    host: window.top.location.host
                };
            } else {
                return {
                    protocol: window.location.protocol,
                    host: window.location.host
                };
            }
        }

        window.useMap = function (id, home, home_icon, tracker_icon) {
            const map = { id, home, home_icon, tracker_icon };
            if (typeof (google) === 'undefined') {
                window.google = null;
                window.mapZoom = {%zoom%};
                window.socket = [];
                window.map = [];
                window.homeMarker = [];
                window.trackerMarker = [];
                window.trackerMarkerState = [];
                window.derferredMaps = [map];
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.src = "//maps.googleapis.com/maps/api/js?key={%apikey%}&callback=initMaps";
                document.getElementsByTagName("head")[0].appendChild(script);
            } else if (google === null) {
                window.derferredMaps.push(map);
            } else {
                window.initMap(id, home, home_icon, tracker_icon);
            }
        }

        window.moveMapMarker = function (id, latitude, longitude, heading = 0) {
            const latLng = new google.maps.LatLng(latitude, longitude);
            if (window.trackerMarker[id]) {
                window.trackerMarker[id].setPosition(latLng);
                window.trackerMarker[id].setIcon({
                    url: window.trackerMarker[id].icon.url,
                    scaledSize: new google.maps.Size(36, 36),
                    rotation: heading
                });
            }
        }
        

        window.initMaps = function () {
            for (let map of window.derferredMaps) {
                window.initMap(map.id, map.home, map.home_icon, map.tracker_icon);
            }
        }

        window.initMap = function (id, home, home_icon, tracker_icon) {
            const location = window.detectLocation();

            if (typeof (window.socket[id]) !== 'undefined') {
                window.socket[id].close();
            }

            
            
            window.socket[id] = new WebSocket(
                location.protocol.replace(/^http/, 'ws') +
                "//" + location.host + "/hook/position_tracking/" + id.toString()
            );

            window.socket[id].addEventListener('message', function (event) {
                const data = JSON.parse(event.data);
                window.moveMapMarker(id, data.latitude, data.longitude, data.heading || 0);
            });

            const mapCenter = JSON.parse('{%map_center%}');
            const centerLatLng = new google.maps.LatLng(mapCenter.latitude, mapCenter.longitude);
            
            const homeLocation = JSON.parse(home);
            const homeLatLng = new google.maps.LatLng(homeLocation.latitude, homeLocation.longitude);
            
            const options = {
                zoom: window.mapZoom,
                center: centerLatLng,
                mapTypeId: '{%maptype%}',
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: false
            };

            window.map[id] = new google.maps.Map(document.getElementById('map-canvas-' + id.toString()), options);

            window.disableFollow = function (id) {
                window.trackerMarkerState[id] = "paused";
                if (window.map[id].controls[google.maps.ControlPosition.TOP_RIGHT].length === 0) {
                    const button = document.createElement("button");
                    button.textContent = "{%follow_vehicle%}";
                    button.classList.add('map-button-' + id.toString());
                    button.addEventListener("click", () => {
                        window.trackerMarkerState[id] = "follow";
                        window.map[id].setZoom(window.mapZoom);
                        window.map[id].panTo(window.trackerMarker[id].position);
                        window.map[id].controls[google.maps.ControlPosition.TOP_RIGHT].pop();
                    });
                    window.map[id].controls[google.maps.ControlPosition.TOP_RIGHT].push(button);
                }
            };

            window.map[id].addListener("zoom_changed", () => {
                if (window.map[id].getZoom() !== window.mapZoom) {
                    window.disableFollow(id);
                }
            });

            window.map[id].addListener("dragend", () => {
                window.disableFollow(id);
            });

            window.homeMarker[id] = new google.maps.Marker({
                position: homeLatLng,
                map: window.map[id],
                icon: {
                    url: 'data:image/png;base64,' + home_icon,
                    scaledSize: new google.maps.Size(36, 36)
                }
            });

            fetch(location.protocol + "//" + location.host + "/hook/position_tracking/" + id.toString())
                .then(response => response.json())
                .then(data => {
                    let trackerLatLng = new google.maps.LatLng(data.latitude, data.longitude);
            
                    const heading = {%heading_angle%};  // Replace with a numeric angle, injected from PHP
            
                    const icon = {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                            `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 100 100" transform="rotate(${heading})">
                                <image href="data:image/png;base64,${tracker_icon}" height="100" width="100"/>
                            </svg>`
                        ),
                        scaledSize: new google.maps.Size(36, 36)
                    };
            
                    window.trackerMarker[id] = new google.maps.Marker({
                        position: trackerLatLng,
                        map: window.map[id],
                        icon: icon
                    });
            
                    window.trackerMarkerState[id] = "follow";
                });
            

        }

        useMap(parseInt('{%id%}'), '{%home%}', '{%home_icon%}', '{%tracker_icon%}');
    </script>
</head>
<body>
    <div id="map-canvas-id"></div>
</body>
</html>
